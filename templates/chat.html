{% extends "layout.html" %}
{% block title %}Czat z AI{% endblock %}
{% block content %}

<h1>üß† Czat z Wirtualnym TerapeutƒÖ</h1>

<div id="chat-layout">
  <div id="chat-container">
    {% for wpis in historia %}
      {% if wpis.ai %}
        <div class="message-row bot">
          <div class="message bot-message">{{ wpis.wiadomosc }}</div>
        </div>
      {% elif wpis.user %}
        <div class="message-row user">
          <div class="message user-message">{{ wpis.wiadomosc }}</div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div id="emoji-bar">
    <span>üòÄ</span><span>üò¢</span><span>üò°</span><span>‚ù§Ô∏è</span><span>üôå</span>
    <span>ü§î</span><span>üî•</span><span>üí§</span><span>üòû</span>
  </div>

  <form id="chat-form">
    <button type="button" id="emoji-toggle">üòä</button>
    <textarea id="wiadomosc" name="wiadomosc" rows="1" placeholder="Napisz wiadomo≈õƒá..." required></textarea>
    <button type="submit">Wy≈õlij</button>
  </form>
</div>

<style>
  html, body {
    height: 100vh;
    margin: 0;
    overflow: hidden;
  }

  main {
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  h1 {
    text-align: center;
    margin: 10px 0;
  }

  #chat-layout {
    display: flex;
    flex-direction: column;
    flex: 1;
    position: relative;
  }

  #chat-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px 15px;
    max-width: 700px;
    margin: auto;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  .message-row {
    display: flex;
    margin: 6px 0;
  }

  .message-row.user { justify-content: flex-end; }
  .message-row.bot { justify-content: flex-start; }

  .message {
    padding: 10px 14px;
    border-radius: 12px;
    max-width: 75%;
    word-wrap: break-word;
    font-size: 15px;
    background-color: #e6f3ff;
    color: #000;
  }

  .user-message { background-color: #dcf8c6; text-align: right; }
  .bot-message { background-color: #fff; border: 1px solid #ddd; }

  #emoji-bar {
    display: none;
    justify-content: center;
    gap: 10px;
    padding: 8px;
    font-size: 24px;
    background-color: #f9f9f9;
    border-top: 1px solid #ddd;
    flex-wrap: wrap;
    position: relative;
    z-index: 10;
  }

  #emoji-bar span {
    cursor: pointer;
    transition: transform 0.1s;
  }

  #emoji-bar span:hover {
    transform: scale(1.2);
  }

  #chat-form {
    display: flex;
    justify-content: center;
    padding: 12px 20px;
    background: #ffffff;
    border-top: 1px solid #ccc;
    z-index: 30;
  }

  #emoji-toggle {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 24px;
    margin-right: 8px;
  }

  #chat-form textarea {
    flex: 1;
    max-width: 700px;
    padding: 10px;
    resize: none;
    border-radius: 20px;
    border: 1px solid #ccc;
    font-size: 14px;
    height: 45px;
  }

  #chat-form button[type="submit"] {
    margin-left: 10px;
    padding: 10px 20px;
    border-radius: 20px;
    border: none;
    background: #4caf50;
    color: white;
    cursor: pointer;
    height: 45px;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('chat-form');
  const textarea = document.getElementById('wiadomosc');
  const chatContainer = document.getElementById('chat-container');
  const emojiBar = document.getElementById('emoji-bar');
  const emojiToggle = document.getElementById('emoji-toggle');

  emojiToggle.addEventListener('click', () => {
    emojiBar.style.display = emojiBar.style.display === 'flex' ? 'none' : 'flex';
  });

  emojiBar.addEventListener('click', (e) => {
    if (e.target.tagName === 'SPAN') {
      const emoji = e.target.textContent;
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      textarea.value = textarea.value.substring(0, start) + emoji + textarea.value.substring(end);
      textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
      textarea.focus();
    }
  });

  textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.dispatchEvent(new Event('submit'));
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const message = textarea.value.trim();
    if (!message) return;

    addMessageRow('user', message);
    textarea.value = '';

    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({message})
    });

    const data = await res.json();
    if (data?.response) {
      typeMessage('bot', data.response);
    } else {
      addMessageRow('bot', 'WystƒÖpi≈Ç b≈ÇƒÖd podczas generowania odpowiedzi.');
    }
  });

  function addMessageRow(role, text) {
    const row = document.createElement('div');
    row.className = `message-row ${role}`;
    const bubble = document.createElement('div');
    bubble.className = `message ${role === 'user' ? 'user-message' : 'bot-message'}`;
    bubble.textContent = text;
    row.appendChild(bubble);
    chatContainer.appendChild(row);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function typeMessage(role, text) {
    const row = document.createElement('div');
    row.className = `message-row ${role}`;
    const bubble = document.createElement('div');
    bubble.className = `message ${role === 'bot' ? 'bot-message' : 'user-message'}`;
    row.appendChild(bubble);
    chatContainer.appendChild(row);

    let i = 0;
    function typing() {
      if (i < text.length) {
        bubble.textContent += text.charAt(i++);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        setTimeout(typing, 15);
      }
    }
    typing();
  }
});
</script>

{% endblock %}

